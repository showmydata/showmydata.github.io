---
layout: post
title: "2022春-计网-第11讲"
categories: 
  - Courses
tags:
  - 课程学习
  - 计算机网络
last_modified_at: 2022-03-30T22:10:52+08:00u
---

### 路由器体系结构

#### 路由器核心功能

- 路由（RIP，OSPF，BGP）
- 转发（从输入端端口到输出端端口）

#### 路由器结构

- 路由处理器
  - 软件层面，控制层级，ms级
- 高速交换结构
  - 硬件层面，数据层级，ns级
- 输入端口
- 输出端口

#### 输入端口

- 结构

  - 线性终端
    - 物理层
    - 比特级接收器

  - 链路层协议

  - 查表，转发，排队
    - 分组的交换
    - 给定目标地址，查表找到输出端口
    - 目标：以线性速度进行转发
    - 排队：如果数据报到达速度超过转发速度

- 问题
  - 队列头阻塞：Head-of-the-Line(HOL) blocking
  - 排队时延和丢包

#### 交换结构

- 把传输包从输入缓存区发送到指定的输出缓存区
- 交换速率
- 三种交换结构
  - memory
    - CPU控制交换
    - 取决于内存带宽
  - bus
    - 共享总线
    - 限制转发速率
  - crossbar
    - 并行地进行交换

#### 输出端口

- 结构：输入端口的逆转
- 重要机制
  - 缓存
  - 调度原则
- 缓存区大小
  - RFC 3439经验法则：”typical“ RTT(250 msec) * link capacity C
  - 最近的建议：N个输入，$\frac{RTT\cdot C}{\sqrt {N}}$
- 调度策略
  - FIFO先进先出
  - 丢弃政策
    - 队尾丢弃
    - 随机丢弃
    - 优先级丢弃
  - 优先级调度
    - 根据源/目标IP，端口号等确定优先级
  - 循环调度RR
    - 每类的分组都发送一遍
  - 加权公平排队WFQ

#### 网络设备对比

|                    | 集线器 | 交换机 | 网桥 | 路由器 |
| ------------------ | ------ | ------ | ---- | ------ |
| 层次               | 1      | 2      | 2    | 3      |
| 流量隔离<br>冲突域 | no     | yes    | yes  | yes    |
| 广播域隔离         | no     | no     | no   | yes    |
| 即插即用           | yes    | yes    | yes  | no     |
| 优化路由           | no     | no     | no   | yes    |
| 直通传输           | yes    | yes    | yes  | no     |

### IP协议

##### 网络层主要功能

- 路由协议：路径选择
- IP协议：寻址规约；数据报（分组）格式；分组处理规约
- ICMP协议：差错报告；路由器”信令“

##### IPv4数据报（分组）格式

- 固定部分是20B
  - 版本号4bit：4->IPv4，6->IPv6
  - 首部长度4bit：以4B为单位
  - 服务类型(TOS)8bit：区分服务，一般情况下不使用，通常为00H
  - 总长度(首部+数据)2B
    - 最大IP分组：65535B
    - 最小IP分组首部：20B
    - IP分组可以封装的最大数据：65515B
  - 标识2B
  - 标志位3bit
  - 片位移13bit
  - 生存时间TTL：1B，经过的路由器数，或跳步数
  - 协议1B：6为TCP，17为UDP
  - 首部校验和2B：实现对IP分组首部的差错检测
    - 计算校验和时，该字段置全0
    - 采用反码算数运算求和，和的反码作为首部校验和字段
    - 逐跳计算、逐跳校验
  - 源IP地址4B
  - 目的IP地址4B
- 可变部分：
  - 选项字段
    - 1~40B，携带安全、源选路径、时间戳和路由记录等内容
    - 实际上很少被使用
  - 填充字段
    - 0~3B，补齐整个首部，符合32位对齐，即保证首部长度是4B的倍数

##### 最大传输单元（MTU）

- 链路层数据帧可封装数据的上线
- 不同链路的MTU不同
- 最大传输单元是最大IP分组长度

#### IP分片与重组

- 大IP分组向较小MTU链路转发时，可以被分片
  - 1个IP分组分为多片IP分组
  - IP分片到达目的主机后进行重组
- IP首部的相关字段用于标识分片及确定分片的相对顺序
  - 总长度
  - 标识：标识一个IP分组
    - 每产生一个IP分组计数器加1，作为该IP分组的标识
  - 标志位3bit
    - 保留位
    - DF：1禁止分片，0允许分片
    - MF：1非最后一片，0最后一片或未分片
  - 片偏移13bit
    - 一个IP分组分片封装原IP分组数据的相对偏移量
    - 片偏移字段以8字节为单位

#### IP分片过程

- 假设原IP分组总长度为L，待转发链路的MTU为M

- 若L>M，且DF=0，则可以/需要分片

- 分片时每个分片的标识复制原IP分组的标识

- 通常分片时，除最后一个分片，其它分片均分为MTU允许的最大分片

- 一个最大分片可封装的数据应该是8的倍数

  - $d=\lfloor \frac{M-20}{8} \rfloor \times 8$ 

- 需要的总片数为：

  - $n=\lceil \frac{L-20}{d} \rceil$

- 每片的片偏移字段取值为

  - $F_i=\frac{d}{8}\times (i-1),\quad 1\le i\le n$

- 每片的总长度字段为

  - $$
    L_i=
    \left\{
    \begin{array}{**lr}
    d+20 & 1\le i \lt n \\
    L-(n-1)d & i=n
    \end{array}
    \right.
    $$

- 每片的MF标志位为

  - $$
    MF_i=
    \left\{
    \begin{array}{**lr}
    1 & 1\le i \lt n \\
    0 & i=n
    \end{array}
    \right.
    $$



