---
layout: post
title: "2022春-计网-第16讲"
categories: 
  - Courses
tags:
  - 课程学习
  - 计算机网络
last_modified_at: 2022-04-15T21:10:52+08:00u
---

### 传输层

#### 传输层服务

##### 传输层服务和协议

- 传输层协议为运行在不同Host上的进程提供了一种逻辑通信机制
- 端系统运行传输层协议
  - 发送方：将应用递交的消息分成一个或多个Segment，并向下传给网络层
  - 接收方：将接收到的Segment组装成消息，并向上交给应用层
- 传输层多种协议
  - TCP
  - UDP

##### 传输层 vs 网络层

- 网络层：提供主机之间的逻辑通信机制
- 传输层：提供应用进程之间的逻辑通信机制
  - 位于网络层之上
  - 依赖于网络层服务
  - 对网络层服务进行（可能的）增强

##### Internet传输层协议

- 可靠、按需的交付服务（TCP）
  - 拥塞控制
  - 流量控制
  - 连接建立
- 不可靠的交付服务（UDP）
  - 基于“尽力而为”的网络层，没有做可靠性扩展
- 两种服务均不保证
  - 延迟
  - 带宽

####传输层多路复用/分用

##### 如何多路分用/复用

- 接收端进行多路分用：
  - 传输层依据头部信息将收到的Segment交给正确的Socket，即不同的进程
- 发送端进行多路复用：
  - 从多个Socket接收数据，为每块数据封装上头部信息，生成Segment，交给网络层

##### 传输层分用如何工作

- 主机接收到IP数据报
  - 每个数据报携带源IP地址、目的IP地址
  - 每个数据报携带一个传输层的段
  - 每个段携带源端口号和目的端口号
- 主机收到Segment后，传输层协议提取IP地址和端口号信息，将Segment导向响应的Socket
  - TCP做更多处理

##### 传输层无连接分用

- 利用端口号创建Socket
- UDP的Socket用二元组标识
  - 目的IP地址，目的端口号
- 主机收到UDP段后
  - 检查段中的目的端口号
  - 将UDP段导向绑定在该端口号的Socket
- 来自不同源IP地址和/或源端口号的IP数据报被导向同一个Socket

##### 传输层面向连接的分用

- TCP的Socket用四元组标识
  - 源IP地址，源端口号，目的IP地址，目的端口号
- 接收端利用所有的四个值将Segment导向合适的Socket
- 服务器可能同时支持多个TCP Socket
  - 每个Socket用自己的四元组标识
- Web服务器为每个客户端开不同的Socket

#### UDP协议

- UDP：User Datagram Protocol
- 基于Internel IP协议
  - 复用/分用
  - 简单的错误校验
- “Best effort”服务，UDP段可能
  - 丢失
  - 非按序到达
- 无连接
  - UDP发送方和接收方之间不需要握手
  - 每个UDP段的处理独立于其它段
- UDP为什么存在
  - 无需建立连接（减少延迟）
  - 实现简单：无需维护连接状态
  - 头部开销小，8B
  - 没有拥塞控制：应用可更好地控制发送时间和速率
- 常用于流媒体应用
  - 容忍丢失
  - 速率敏感
- UDP还用于
  - DNS
  - SNMP
- 在UDP上实现可靠数据传输
  - 在应用层增加可靠性机制
  - 应用特定的错误恢复机制

##### UDP校验和

- 目的：检测UDP段在传输中是否发生错误（如位翻转）
- 发送方
  - 将段的内容视为16-bit证书
  - 校验和计算：计算所有整数的和，进位加在和的后面，将得到的值按位求反，得到检验和
  - 发送方将检验和放入校验和字段
- 接收方
  - 计算所收到段的校验和
  - 将其与校验和字段进行对比
    - 不相等：检测出错误
    - 相等：没有检测出错误（但可能有错误）
- 计算包括三部分
  - IP伪首部
  - UDP首部
  - 应用数据（包括padding填充字段）

#### TCP协议

##### TCP概述

- 点对点
  - 一个发送方，一个接收方
- 可靠的、按序字节流
- 流水线机制
  - TCP拥塞控制和流量控制，机制设置窗口尺寸
- 发送方/接收方缓存
- 全双工
  - 同一连接中能够传输双向数据流
- 面向连接
  - 通信双方在发送数据之前必须建立连接
  - 连接状态只在连接的两端中维护，在沿途节点中并不维护状态
  - TCP连接包括：两台主机上的缓存、连接状态变量、socket等
- 流量控制机制
- 拥塞控制

##### TCP段结构

- 源端口号2B、目的端口号2B
- 序列号4B
- ACK确认号4B
- head len、not used、U、A、P、R、S、F
  - U：URG，urgent data，通常情况下不使用
  - A：ACK valid
  - P：PSH，push data now，通常情况下不使用
  - RST，SYN，FIN：连接建立（setup，teardown commands）
- Receive window：bytes rcvr willing to accept
- checksum
- urg data pnter
- options

##### TCP：序列号和ACK

- 序列号
  - segment中第一个字节的编号
  - 建立TCP连接时，双方随机选择序列号
- ACKs
  - 希望接收到的下一个字节的序列号
  - 累计确认：该序列号之前的所有字节均已被正确接收到
- 接收方如何处理乱序到达的Segment
  - TCP规范中没有规定，由TCP的实现者做出决策

##### TCP可靠数据传输概述

- TCP在IP层提供的不可靠服务基础上实现可靠数据传输服务
- 流水线机制
- 累积确认
- TCP使用单一重传定时器
- 触发重传的事件
  - 超时
  - 收到重复的ACK
- 渐进式

##### TCP RTT和超时

- 如何设置定时器的超时事件
  - 大于RTT：但是RTT是变化的
  - 过短：不必要的重传
  - 过长：对段丢失事件反应慢
- 如何估计RTT
  - SampleRTT：测量从段发出去到收到ACK的事件，忽略重传
  - SampleRTT变化：测两多个SampleRTT，求平均值，行程RTT的估计值EstimatedRTT
- 定时器超时事件的设置：
  - EstimatedRTT + ”安全边界“
  - EstimatedRTT变化大 -> 较大的边界
- 测量RTT的变化值：SampleRTT与EstimatedRTT的差值
  - DevRTT = (1- beta) * DevRTT + beta * |SampleRTT - EstimatedRTT|
  - (typically, beta = 0.25)
- 定时器超时时间的设置：
  - TimeoutInterval = EstimatedRTT + 4*DevRTT

##### TCP发送方事件

- 从应用层收到数据
  - 创建Segment
  - 序列号是Segment第一个字节的编号
  - 开启计时器
  - 设置超时事件
- 超时
  - 重传引起超时的Segment
  - 重启定时器
- 收到ACK
  - 如果确认此前未确认的Segment
    - 更新SendBase
    - 如果窗口中还有未被确认的分组，重新启动定时器









