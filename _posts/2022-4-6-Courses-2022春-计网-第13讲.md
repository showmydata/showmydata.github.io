---
layout: post
title: "2022春-计网-第13讲"
categories: 
  - Courses
tags:
  - 课程学习
  - 计算机网络
last_modified_at: 2022-04-06T22:10:52+08:00u
---

### IP相关协议

#### 地址解析协议(ARP)

- ARP表：LAN中的每个IP结点（主机、路由器）维护一个表
  - 存储某些LAN结点的IP/MAC地址映射关系<IP地址；MAC地址；TTL>
  - TTL（Time to Live)：存活时间，常为20min
- ARP协议：同一局域网内
  - A想给同一局域网内的B发送数据报，
    - B的MAC地址不在A的ARP表中
  - A广播ARP查询分组，其中包括B的IP地址
    - 目的MAC地址=FF-FF-FF-FF-FF-FF
    - LAN中所有结点都会接收ARP查询
  - B接收ARP查询分组，IP地址匹配成功，向A应答B的MAC地址
    - 利用单播帧向A发送应答
  - A在其ARP表中，缓存B的IP-MAC地址对，直至超时
    - 超时后，再次刷新
  - ARP是”即插即用“协议
    - 结点自主创建ARP表，无需干预
- 寻址：从一个LAN路由至另一个LAN
  - A构造IP数据报，源IP地址是A的IP地址，目的IP地址是B的IP地址
  - A构造链路层帧，其中源MAC地址是A的MAC地址，目的MAC地址是网关路由器的左接口MAC地址，封装A到B的IP数据报
  - 帧从A发送到网关
  - 网关接收到帧，提取IP数据报，传递给上层IP协议
  - 网关转发IP数据报
  - 网关创建链路层帧，其中源MAC地址是网关右接口的MAC地址，目的MAC地址是B的MAC地址，封装A到B的IP数据报

#### 互联网控制报文协议(ICMP)

- 支持主机或路由器
  - 差错（或异常）报告
  - 网络探询
- 两类ICMP报文
  - 差错报告报文（5种）
    - 目的不可达
    - 源抑制（降低源主机发送速率，降低丢包率）
    - 超时/超期
    - 参数问题
    - 重定向
  - 网络探询报文（2组）
    - 回声请求与应答报文
    - 时间戳请求与应答报文
- 例外情况
  - 集中不发送ICMP差错报告报文的特殊情况
    - 对ICMP差错报告报文不再发送ICMP差错报告报文
    - 除第1个IP数据报分片外，对所有后续分片均不发送ICMP差错报告报文
    - 对所有多播IP数据报均不发送ICMP差错报告报文
    - 对具有特殊地址的IP数据(如127.0.0.0和0.0.0.0)报不发送ICMP差错报告报文
  - 集中ICMP报文已不再使用
    - 信息请求与应答报文
    - 子网掩码请求和应答报文
    - 路由器询问和通告报文
- ICMP报文格式：ICMP报文封装到IP数据报种传输（IP首部+ICMP报文）
  - 类型8bit
  - 代码8bit
  - 检验和16bit
  - 后4B取决于ICMP报文的类型
  - ICMP的数据部分（长度取决于类型）
- ICMP的应用距离：Traceroute

#### 动态主机配置协议(DHCP)

- 主机如何获得IP地址

  - 硬编码-静态配置
  - 从服务器动态获取
    - IP地址
    - 子网掩码
    - 默认网关地址
    - DNS服务器名称与IP地址
  - 即插即用
  - 允许地址重用
  - 支持在用地址续租
  - 支持移动用户加入网络

- 主机获得租赁IP地址的过程

  - 主机广播“DHCP discover”发现报文

  - DHCP服务器利用“DHCP offer”提供报文进行响应
  - 主机请求IP地址“DHCP request”请求报文
  - DHCP服务器分配IP地址“DHCP ack”确认报文

- DHCP协议在应用层实现
  - DHCP报文封装到UDP数据报种
- DHCP服务器构造ACK报文
  - 包括分配给客户的IP地址、子网掩码、默认网关、DNS服务器地址

#### 网络地址转换(NAT)

- 动机
  - 只需/能从ISP申请一个IP地址
    - IPv4地址耗尽
  - 本地网络设备IP地址的变更，无需通告外界网络
  - 变更ISP时，无需修改内部网络设备IP地址
  - 内部网络设备对外界网络不可见，即不可直接寻址（安全）
- 实现
  - 替换：利用(NAT IP地址，新端口号)替换每个外出IP数据报的(源IP地址，源端口号)
  - 记录：将每对(NAT IP地址，新端口号)与(源IP地址，源端口号)的替换信息存储到NAT转换表种
  - 替换：根据NAT转换表，利用其进行替换
- 16bit端口号字段：可同时支持60000多并行连接
- NAT主要争议
  - 路由器应该只处理第3层功能
  - 违背端到端通信原则
    - 应用开发者必须考虑到NAT的存在，e.j.，P2P应用
  - 地址短缺问题应该由IPv6来解决
- NAT穿透问题
  - 解决方案1：静态配置NAT，将特定端口的连接请求转发给服务器
    - 例如，将(138.76.29.7, 2500)总是转发给(10.0.0.1, 25000)
  - 解决方案2：利用UPnP互联网网关设备协议(IGD)自动配置
    - 学习到NAT公共IP地址
    - 在NAT转换表中，增删端口映射
  - 解决方案3：中继(如Skype)
    - NAT内部的客户与中继服务器简历连接
    - 外部客户也与中继服务器建立连接
    - 中继服务器桥接两个连接的分组



